<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Mapa Sanitario - Provincia de C√≥rdoba</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet"/>
<link href="style.css" rel="stylesheet"/>

</head>
<body>
<div id="header-blue">
<div id="header-title">Mapa Sanitario - Municipalidad de C√≥rdoba</div>
<div id="header-logos">
<div class="logo-container">
<img alt="Secretar√≠a de Salud" src="SecreB.png"/>
</div>
<div class="logo-container">
<img alt="Coordinaci√≥n Tecnol√≥gica" src="HorizontalCTWhite.png"/>
</div>
</div>
</div>
<div id="header-bars">
<div class="bar" style="background-color: #FFDA63;"></div>
<div class="bar" style="background-color: #DC3545;"></div>
<div class="bar" style="background-color: #007BFF;"></div>
</div>

<div id="left-panel">
<!-- 2. BUSCADOR -->
<div id="search-container">
<input id="search-efector" placeholder="Buscar Efector..." type="text"/>
</div>
<!-- 1. LEYENDA -->
<div id="leyenda-iconos">
<div><img src="CS.png"/> Centros de Salud</div>
<div><img src="HOSP-HPA-PLM.png"/> Hospitales Municipales, HPA, Padre La Monaca</div>
<div><img src="EFECTORES.png"/> Efectores Municipales</div>
</div>
<!-- 3. FILTROS PROVINCIA -->
<div class="filter-group">
<div class="filter-group-title">Filtros a Nivel Provincia</div>
<div class="filter-group-content">
<label><input id="chkDEPARTAMENTOS" type="checkbox"/> DEPARTAMENTOS</label>
<label><input id="chkLOCALIDADES" type="checkbox"/> LOCALIDADES</label>
</div>
</div>
<!-- 4. FILTROS CAPITAL -->
<div class="filter-group">
<div class="filter-group-title">Filtros a Nivel Capital</div>
<div class="filter-group-content">
<label for="selZONA">
<div style="display: flex; align-items: center; gap: 6px;">
<div id="return-button" style="display: none; cursor: pointer;">
<img alt="Volver" src="atras.png" style="width: 22px; height: 22px;">
</img></div>
<select id="selZONA">
<option value="">-- Seleccionar Zona --</option>
<option value="all">Todas las Zonas</option>
</select>
</div>
</label>
<label><input id="chkCIRCUITO" type="checkbox"/> CIRCUITOS</label>
<label><input id="chkSECCIONALES" type="checkbox"/> SECCIONALES</label>
<label><input id="chkENTEMETROPOLITANO" type="checkbox"/> ENTE METROPOLITANO</label>
</div>
</div>
<!-- 5. FILTROS DE CALOR -->
<div class="filter-group">
<div class="filter-group-title">Filtros de Epidemiolog√≠a</div>
<div class="filter-group-content">
<label>
<select id="filtro-anio">
<option value="">-- A√±o --</option>
<option value="2024">2024</option>
<option value="2025">2025</option>
</select>
</label>
<label>
<select id="filtro-mes">
<option value="">-- Mes --</option>
<option value="1">Enero</option>
<option value="2">Febrero</option>
<option value="3">Marzo</option>
<option value="4">Abril</option>
<option value="5">Mayo</option>
<option value="6">Junio</option>
<option value="7">Julio</option>
<option value="8">Agosto</option>
<option value="9">Septiembre</option>
<option value="10">Octubre</option>
<option value="11">Noviembre</option>
<option value="12">Diciembre</option>
</select>
</label>
<label>
<select id="filtro-semana">
<option value="">-- Semana Epidemiol√≥gica --</option>
                
            </select>
</label>
<label>
<select id="filtro-diagnostico">
<option value="">-- Diagn√≥stico --</option>
<!-- opciones din√°micas -->
</select>
</label>
</div>
</div>
</div>
<div id="map"></div>
<div id="zona-info">
<div id="zona-titulo" style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #005288;">
            Poblaci√≥n de Zona
        </div>
<div id="zona-datos"></div>
</div>
<div id="all-zones-summary-panel">
<h3>Poblaci√≥n por Zona</h3>
<div class="total-population" id="total-capital-population" style="display: none;"></div>
<ul id="all-zones-list"></ul>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
        let atencionesData = null;
        let efectoresData = null;
        let capaEfectores = null;
        const capas = {}; // Objeto para almacenar las capas de GeoJSON (la geometr√≠a)
        const capasLabels = {}; // Objeto para almacenar las capas de etiquetas (los nombres)
        let allZonasFeatures = []; // Para guardar todas las features de zonas
        let allZonasDataLoaded = false; // Flag para saber si los datos de zonas est√°n cargados
        let capaHeatmap = null;
        let diagChoices = null;

        const P = {
            year:  p => p.A√±o ?? p.ANIO ?? p.Anio ?? p.anio ?? p.A√ëO,
            month: p => p.Mes ?? p.MES ?? p.mes,
            week:  p => p.SEMANAEPIDEMIOLOGICA ?? p.SemanaEpidemiologica ?? p.semanaEpidemiologica ?? p.semana ?? p.SEMANA,
            diag:  p => p.Diagnostico ?? p.DIAGNOSTICO ?? p.diagnostico
            };

        // Referencias a los elementos del DOM
        const selZONA = document.getElementById('selZONA');
        const returnButton = document.getElementById('return-button');
        const zonaInfoPanel = document.getElementById('zona-info');
        const allZonesSummaryPanel = document.getElementById('all-zones-summary-panel');
        const allZonesList = document.getElementById('all-zones-list');
        const totalCapitalPopulationDiv = document.getElementById('total-capital-population');
        
        let datosZonasPoblacion = [];

        document.addEventListener("DOMContentLoaded", () => {
                      
            const map = L.map('map').setView([-31.42, -64.18], 11);

            const iconoEfectores = L.icon({
                iconUrl:'EFECTORES.png',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36],
            });
            
            diagChoices = new Choices("#filtro-diagnostico", {
                searchEnabled: true,
                itemSelectText: '',
                shouldSort: false,
                placeholder: true,
                placeholderValue: "Buscar diagn√≥stico...",
            });

            const iconoHPA = L.icon({
                iconUrl: 'HOSP-HPA-PLM.png',
                iconSize: [38, 38],
                iconAnchor: [19, 38],
                popupAnchor: [0, -38],
            });

            const iconoCentroSalud = L.icon({
                iconUrl: 'CS.png', // Aseg√∫rate de tener esta imagen en la misma carpeta
                iconSize: [28, 28],
                iconAnchor: [14, 28],
                popupAnchor: [0, -28],
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(map);

            const estilos = (feature) => ({
                color: feature.properties.stroke || '#3388ff',
                weight: feature.properties['stroke-width'] || 2,
                opacity: feature.properties['stroke-opacity'] || 1,
                fillColor: feature.properties.fill || '#3388ff',
                fillOpacity: feature.properties['fill-opacity'] || 0.3,
            });

            // Funci√≥n para obtener el nombre de la feature (para etiquetas y popups)
            function getFeatureName(props, layerName) {
                // *** POR FAVOR, REEMPLAZA 'nombre_propiedad_real' CON EL NOMBRE DE LA PROPIEDAD EN TUS JSONS ***
                // EJEMPLO: if (layerName === 'BARRIOS' && props.hasOwnProperty('NOMBRE_DEL_BARRIO')) { return props.NOMBRE_DEL_BARRIO; }
                if (layerName === 'BARRIOS' && props.hasOwnProperty('nombre_propiedad_real_barrio')) { 
                    return props.nombre_propiedad_real_barrio;
                }
                if (layerName === 'CIRCUITO' && props.hasOwnProperty('circuito')) { 
                    return props.circuito;
                }
                if (layerName === 'LOCALIDADES' && props.hasOwnProperty('nombre_propiedad_real_localidad')) { 
                    return props.nombre_propiedad_real_localidad;
                }
                if (layerName === 'SECCIONALES' && props.hasOwnProperty('nombre_seccional')) { // Ejemplo, si seccionales tiene una propiedad diferente
                    return props.nombre_seccional;
                }
                if (layerName === 'ENTEMETROPOLITANO' && props.hasOwnProperty('localidad')) {
                    return props.localidad;
                }
                if (layerName === 'DEPARTAMENTOS' && props.hasOwnProperty('nombre_departamento')) { // Ejemplo
                    return props.nombre_departamento;
                }


                // Prioridad gen√©rica (si no se especifica una propiedad para la capa)
                if (props.name) return props.name;
                if (props.NOM_ZONA) return props.NOM_ZONA;
                if (props.CODIGO) return props.CODIGO;

                // Si no se encuentran las anteriores, busca la primera propiedad que parezca un nombre
                for (const key in props) {
                    if (typeof props[key] === 'string' && props[key].length > 1 && !/^\d+$/.test(props[key])) {
                        return props[key];
                    }
                }
                console.warn(`No se encontr√≥ una propiedad de nombre clara para la capa ${layerName}. Propiedades:`, props);
                return 'Sin nombre';
            }

            // Funci√≥n para calcular el centroide del bounding box de un pol√≠gono/multipol√≠gono (m√°s simple)
            function getCentroid(feature) {
                if (feature.geometry && feature.geometry.coordinates) {
                    try {
                        const geoJsonLayer = L.geoJSON(feature);
                        if (geoJsonLayer.getBounds().isValid()) {
                            return geoJsonLayer.getBounds().getCenter();
                        } else {
                            console.warn("Bounds inv√°lidos para la feature, no se pudo calcular el centroide:", feature);
                            return null;
                        }
                    } catch (e) {
                        console.error("Error al calcular el centroide para la feature:", feature, e);
                        return null;
                    }
                }
                return null;
            }

            // Cargar efectores y zonas
           const fetchEfectores = fetch("efectores.geojson")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar efectores.json: ${res.status}`);
                    return res.json();
                });

            const fetchZonasGeo = fetch("zonas.geojson")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar zonas.geojson: ${res.status}`);
                    return res.json();
                });

            const fetchZonasValores = fetch("zonas_valores.json")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar zonas_valores.json: ${res.status}`);
                    return res.json();
                });

            const urlBase ="https://reporteyanalisisdedatos.github.io/MapaCalor_MunicipalidadDeCordoba/";

            // Archivos GeoJSON divididos por mes y parte
            const archivosAtenciones = [
                // 2024
                "atenciones_2024_01.geojson",
                "atenciones_2024_02.geojson",
                "atenciones_2024_03_part1.geojson", "atenciones_2024_03_part2.geojson",
                "atenciones_2024_04_part1.geojson", "atenciones_2024_04_part2.geojson",
                "atenciones_2024_05_part1.geojson", "atenciones_2024_05_part2.geojson",
                "atenciones_2024_06_part1.geojson", "atenciones_2024_06_part2.geojson",
                "atenciones_2024_07_part1.geojson", "atenciones_2024_07_part2.geojson",
                "atenciones_2024_08_part1.geojson", "atenciones_2024_08_part2.geojson", "atenciones_2024_08_part3.geojson",
                "atenciones_2024_09_part1.geojson", "atenciones_2024_09_part2.geojson", "atenciones_2024_09_part3.geojson",
                "atenciones_2024_10_part1.geojson", "atenciones_2024_10_part2.geojson", "atenciones_2024_10_part3.geojson",
                "atenciones_2024_11_part1.geojson", "atenciones_2024_11_part2.geojson",
                "atenciones_2024_12_part1.geojson", "atenciones_2024_12_part2.geojson",

                // 2025
                "atenciones_2025_01_part1.geojson", "atenciones_2025_01_part2.geojson",
                "atenciones_2025_02_part1.geojson", "atenciones_2025_02_part2.geojson",
                "atenciones_2025_03_part1.geojson", "atenciones_2025_03_part2.geojson",
                "atenciones_2025_04_part1.geojson", "atenciones_2025_04_part2.geojson",
                "atenciones_2025_05_part1.geojson", "atenciones_2025_05_part2.geojson",
                "atenciones_2025_06_part1.geojson", "atenciones_2025_06_part2.geojson"
                ];

            // urlBase ya est√° declarado m√°s arriba, as√≠ que solo lo usamos aqu√≠

            function cargarTodosLosGeojson() {
                return Promise.all(
                    archivosAtenciones.map(nombre =>
                    fetch(urlBase + nombre)
                        .then(res => {
                        if (!res.ok) throw new Error(`Error al cargar ${nombre}: ${res.status}`);
                        return res.json();
                        })
                        .catch(err => {
                        console.warn(`‚ö†Ô∏è ${nombre} fall√≥ al cargar:`, err);
                        return { features: [] }; // Evita romper el resto
                        })
                    )
                ).then(arrGeojson => {
                    const todasLasFeatures = arrGeojson.flatMap(g => g.features || []);
                    return { type: "FeatureCollection", features: todasLasFeatures };
                });
            }



            Promise.all([fetchEfectores, fetchZonasGeo, fetchZonasValores, cargarTodosLosGeojson()])
                .then(([efectores, zonasGeo, zonasValores, atenciones]) => {
                    
                    document.getElementById('filtro-anio').addEventListener('change', () => {
                        actualizarDiagnosticos();
                        // al cambiar el contexto, reseteo diagn√≥stico seleccionado
                        diagChoices.removeActiveItems();
                        mostrarMapaDeCalor(atencionesData);
                    });

                    document.getElementById('filtro-mes').addEventListener('change', () => {
                        actualizarDiagnosticos();
                        diagChoices.removeActiveItems();
                        mostrarMapaDeCalor(atencionesData);
                    });

                    document.getElementById('filtro-semana').addEventListener('change', () => {
                        actualizarDiagnosticos();
                        diagChoices.removeActiveItems();
                        mostrarMapaDeCalor(atencionesData);
                    });

                        // si cambia el diagn√≥stico, s√≥lo actualizo el mapa
                    document.getElementById('filtro-diagnostico').addEventListener('change', () => {
                        mostrarMapaDeCalor(atencionesData);
                    });

                    
                    
                    atencionesData = atenciones;
                    actualizarDiagnosticos()
                    mostrarMapaDeCalor(atenciones);

                    // LLENAR FILTRO DE SEMANA EPIDEMIOL√ìGICA
                    const filtroSemana = document.getElementById("filtro-semana");
                    filtroSemana.innerHTML = `<option value="">-- Semana Epidemiol√≥gica --</option>`; // limpiar

                    const semanasSet = new Set();
                    atenciones.features.forEach(f => {
                        const p = f.properties || {};
                        const semana = P.week(p); // usamos el helper para normalizar el nombre
                        if (semana != null && semana !== '') semanasSet.add(Number(semana));
                    });

                    [...semanasSet].sort((a, b) => a - b).forEach(sem => {
                        const opt = document.createElement("option");
                        opt.value = String(sem);
                        opt.textContent = `Semana ${sem}`;
                        filtroSemana.appendChild(opt);
                    });

                    // LLENAR FILTRO DE DIAGN√ìSTICO
                    // --- NUEVO: reconstruye la lista de diagn√≥sticos seg√∫n los filtros actuales ---
                    function actualizarDiagnosticos() {
                        const anioSel   = document.getElementById("filtro-anio").value;
                        const mesSel    = document.getElementById("filtro-mes").value;
                        const semanaSel = document.getElementById("filtro-semana").value;

                        // 1) Filtrar atenciones por anio/mes/semana
                        const setDiag = new Set();
                        (atencionesData?.features || []).forEach(f => {
                            const p = f.properties || {};
                            const y = P.year(p);
                            const m = P.month(p);
                            const w = P.week(p);
                            const d = P.diag(p);

                            const okY = (!anioSel   || String(y) == String(anioSel));
                            const okM = (!mesSel    || String(m) == String(mesSel));
                            const okW = (!semanaSel || String(w) == String(semanaSel));

                            if (okY && okM && okW && d) setDiag.add(String(d));
                        });

                        // 2) Armar opciones para Choices
                        const opciones = Array.from(setDiag).sort().map(diag => ({
                            value: diag, label: diag, selected: false, disabled: false
                        }));

                        // 3) Volcar en Choices (limpia y carga de nuevo)
                        diagChoices.clearStore();          // limpia todo (items + choices)
                        diagChoices.setChoices(
                            [{value: "", label: "-- Diagn√≥stico --", selected: true, disabled: false}, ...opciones],
                            'value', 'label', true
                        );
                    }

                    if (!efectores || !efectores.features) {
                        throw new Error("efectores.json no tiene la estructura esperada.");
                    }
                    if (!zonasGeo || !zonasGeo.features) {
                        throw new Error("zonas.geojson no tiene la estructura esperada.");
                    }
                    if (!Array.isArray(zonasValores)) {
                        throw new Error("zonas_valores.json no es un array.");
                    }

                    efectoresData = efectores.features;
                    allZonasFeatures = zonasGeo.features;
                    datosZonasPoblacion = zonasValores;
                    allZonasDataLoaded = true;

                    console.log("‚úÖ efectores cargados:", efectoresData.length);
                    poblarSelectorZonas(allZonasFeatures);
                    mostrarTodosEfectores();
                    selZONA.value = "";
                    zonaInfoPanel.style.display = 'none';
                    allZonesSummaryPanel.style.display = 'none';
                    returnButton.style.display = 'none';
                
                     // üëá PEG√Å ESTO ADENTRO DEL THEN
                    document.getElementById('search-efector').addEventListener('input', (e) => {
                        let texto = e.target.value.trim().toLowerCase()
                            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // saca acentos
                            .replace(/\bcs\b/g, 'cs') // reemplaza "cs" por "centro de salud";
                            .replace(/\bcs[\s#¬∞¬∫\-]*/g, 'centro de salud ')
                            .replace(/n[¬∞¬∫]?\s*/g, '') // reemplaza "n¬∞", "n¬∫", "n " por vac√≠o
                            .replace(/\s+/g, ' ');     // normaliza espacios dobles


                        if (!texto) {
                            mostrarTodosEfectores();
                            return;
                        }

                        const filtrados = efectoresData.filter(feature => {
                            const nombre = feature.properties?.Centro?.toLowerCase() || '';
                            const nombreNormalizado = nombre
                                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                                .replace(/\bcs\b/g, 'centro de salud')
                                .replace(/\bcs\b/g, 'cs') // reemplaza "cs" por "centro de salud";
                                .replace(/\bcs[\s#¬∞¬∫\-]*/g, 'centro de salud ')
                                .replace(/n[¬∞¬∫]?\s*/g, '') // reemplaza "n¬∞", "n¬∫", "n " por vac√≠o
                                .replace(/\s+/g, ' ');     // normaliza espacios dobles

                            return nombreNormalizado.includes(texto);
                        });

                        if (capaEfectores) {
                            map.removeLayer(capaEfectores);
                        }

                        capaEfectores = L.geoJSON(filtrados, {
                            pointToLayer: (feature, latlng) => {
                            const props = feature.properties;
                            const nombre = (props.Centro || '').toLowerCase();
                            const tipo = (props.Tipo || '').toLowerCase();

                            let icono = iconoCentroSalud;

                            const nombresEspeciales = [
                                'medicina preventiva',
                                'dem',
                                'secretar√≠a de salud',
                                'secretaria de salud',
                                'adicciones',
                                'salud mental',
                                'pec',
                                'direccion de calidad alimentaria',
                                'direccion de emergencias medicas 107',
                                'direccion de epidemiologia',
                                'laboratorio farmaceutico municipal',
                                'telesalud',
                                'pec los robles',
                                'dtc villa el libertador',
                                'pec comercial',
                                'secretar√≠a de prev. y atenc. comunitaria',
                                'secretaria de prev. y atenc. comunitaria',
                                'centro comunitario maldonado'
                            ];

                            if (tipo.includes('hospital') || tipo.includes('hpa') || nombre.includes('padre la monaca')) {
                                icono = iconoHPA;
                            } else if (nombresEspeciales.some(keyword => nombre.includes(keyword))) {
                                icono = iconoEfectores;
                            }

                            return L.marker(latlng, { icon: icono });
                        },
                            onEachFeature: (feature, layer) => {
                                const props = feature.properties;
                                const datosCentro = {
                                    nombre: props.Centro,
                                    tipo: props.Tipo,
                                    direccion: props.Direccion,
                                    institucion: props.institucion || '',
                                    poblacion: props.PoblacionTotal ?? 0,
                                    mujeres: props.Mujeres ?? 0,
                                    hombres: props.Varones ?? 0,
                                    sin_cobertura: props.PoblacionSinCobertura ?? 0,
                                    porcentaje_sin_cobertura: props.PorcentajeSinCobertura ?? 0,
                                    hogares: props.Hogares ?? 0,
                                    hogares_nbi: props.HogaresNBI ?? 0
                                };
                                layer.bindPopup(crearPopupCentroSalud(datosCentro));
                            }
                        }).addTo(map);
                    });

                })
                
                .catch(error => {
                    console.error("Error cargando datos iniciales:", error);
                    if (error.message.includes("Failed to fetch")) {
                        alert("No se pudo conectar al servidor. Verific√° tu conexi√≥n a internet.");
                    } else {
                        alert(`Error al cargar datos: ${error.message}`);
                    }
                });

            const archivosCapas = [
                'CIRCUITO',
                'SECCIONALES',
                'DEPARTAMENTOS',
                'LOCALIDADES',
                'ENTEMETROPOLITANO'
            ];
            

            archivosCapas.forEach((nombre) => {
                fetch(`${urlBase}${nombre}.json`)
                    .then((res) => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status} for ${nombre}.json`);
                        }
                        return res.json();
                    })
                    .then((geojson) => {
                        capas[nombre] = L.geoJSON(geojson, {
                            style: estilos,
                            onEachFeature: (feature, layer) => {
                                // Usar getFeatureName con el nombre de la capa
                                const nom = getFeatureName(feature.properties, nombre);
                                layer.bindPopup(`<strong>${nom}</strong>`);
                            },
                        });

                        // Crear y almacenar los marcadores de etiqueta para esta capa
                        const labelsGroup = L.layerGroup();
                        geojson.features.forEach(feature => {
                            const centroid = getCentroid(feature);
                            if (centroid) {
                                // Usar getFeatureName con el nombre de la capa
                                const name = getFeatureName(feature.properties, nombre);
                                if (name && name !== 'Sin nombre') { 
                                    const labelHtml = `<div class="layer-label">${name}</div>`;
                                    const customIcon = L.divIcon({
                                        className: 'custom-div-icon',
                                        html: labelHtml,
                                        iconSize: [0, 0], 
                                        iconAnchor: [0, 0]
                                    });
                                    const labelMarker = L.marker(centroid, { icon: customIcon });
                                    labelsGroup.addLayer(labelMarker);
                                }
                            }
                        });
                        capasLabels[nombre] = labelsGroup;

                    })
                    .catch((error) => {
                        console.error(`Error cargando ${nombre}.json:`, error);
                        console.log(`Aseg√∫rate de que ${nombre}.json exista, sea un GeoJSON v√°lido y tenga una propiedad de nombre legible.`);
                    });
            });

            function poblarSelectorZonas(zonasFeatures) {
                // Ordenar las zonas num√©ricamente
                zonasFeatures.sort((a, b) => {
                    const idA = parseInt((a.properties.name || '').replace('ZONA ', '').trim());
                    const idB = parseInt((b.properties.name || '').replace('ZONA ', '').trim());
                    return idA - idB;
                });

                zonasFeatures.forEach((feature) => {
                    const zona_id_str = (feature.properties.name || '').replace('ZONA ', '').trim();
                    if (zona_id_str) {
                        const option = document.createElement('option');
                        option.value = zona_id_str;
                        option.textContent = `ZONA ${zona_id_str}`;
                        selZONA.appendChild(option);
                    }
                });

                selZONA.onchange = (e) => {
                    const selectedValue = e.target.value;
                    if (capas.ZONA && map.hasLayer(capas.ZONA)) {
                        map.removeLayer(capas.ZONA);
                    }

                    zonaInfoPanel.style.display = 'none';
                    allZonesSummaryPanel.style.display = 'none';

                    if (selectedValue === 'all') {
                        capas.ZONA = L.geoJSON(
                            {
                                type: 'FeatureCollection',
                                features: allZonasFeatures
                            },
                            {
                                style: estilos,
                                onEachFeature: (feature, layer) => {
                                    const zona_id_str = (feature.properties.name || '').replace('ZONA ', '').trim();
                                    const zona_id = parseInt(zona_id_str) || 0;

                                    layer.on('click', () => {
                                        selZONA.value = zona_id_str;
                                        mostrarEfectoresPorZona(zona_id);
                                        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                                        returnButton.style.display = 'block';
                                        zonaInfoPanel.style.display = 'flex';
                                        allZonesSummaryPanel.style.display = 'none';
                                    });
                                }
                            }
                        ).addTo(map);

                        mostrarTodosEfectores();
                        mostrarResumenTodasZonas();
                        map.setView([-31.42, -64.18], 11);
                        returnButton.style.display = 'block';

                    } else if (selectedValue) {
                        const selectedFeature = allZonasFeatures.find(f =>
                            (f.properties.name || '').replace('ZONA ', '').trim() === selectedValue
                        );

                        if (selectedFeature) {
                            const zona_id = parseInt(selectedValue);
                            capas.ZONA = L.geoJSON(selectedFeature, {
                                style: estilos,
                                onEachFeature: (feature, layer) => {
                                    layer.on('click', () => {
                                        mostrarEfectoresPorZona(zona_id);
                                        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                                        zonaInfoPanel.style.display = 'flex';
                                        allZonesSummaryPanel.style.display = 'none';
                                    });
                                }
                            }).addTo(map);

                            map.fitBounds(L.geoJSON(selectedFeature).getBounds(), { padding: [20, 20] });
                            mostrarEfectoresPorZona(zona_id);
                            returnButton.style.display = 'block';
                        }

                    } else {
                        mostrarTodosEfectores();
                        zonaInfoPanel.style.display = 'none';
                        returnButton.style.display = 'none';
                        allZonesSummaryPanel.style.display = 'none';
                        map.setView([-31.42, -64.18], 11);
                    }
                };
            }

            // Manejador del bot√≥n de retorno
            returnButton.onclick = () => {
                if (selZONA.value === "all") { // Si estamos en "Todas las Zonas", ir a "-- Seleccionar Zona --"
                    selZONA.value = "";
                } else { // Si estamos en una zona espec√≠fica, ir a "Todas las Zonas"
                    selZONA.value = "all";
                }
                const event = new Event('change');
                selZONA.dispatchEvent(event); // Dispara el evento 'change'
            };


            document.getElementById('chkCIRCUITO').onchange = (e) =>
                toggleLayer('CIRCUITO', e.target.checked);
            document.getElementById('chkSECCIONALES').onchange = (e) =>
                toggleLayer('SECCIONALES', e.target.checked);
            document.getElementById('chkENTEMETROPOLITANO').onchange = (e) =>
                toggleLayer('ENTEMETROPOLITANO', e.target.checked);    
            document.getElementById('chkDEPARTAMENTOS').onchange = (e) =>
                toggleLayer('DEPARTAMENTOS', e.target.checked);
            document.getElementById('chkLOCALIDADES').onchange = (e) =>
                toggleLayer('LOCALIDADES', e.target.checked);

            function toggleLayer(nombre, visible) {
                if (!capas[nombre]) {
                    console.warn(`Capa de geometr√≠a '${nombre}' no cargada. Revisa el archivo JSON.`);
                    return;
                }
                // Las etiquetas son opcionales, pero si existen, se manejan
                if (capasLabels[nombre]) {
                    if (visible) {
                        capas[nombre].addTo(map);
                        capasLabels[nombre].addTo(map); 
                    } else {
                        map.removeLayer(capas[nombre]);
                        map.removeLayer(capasLabels[nombre]); 
                    }
                } else {
                    // Si no hay etiquetas, solo maneja la capa de geometr√≠a
                    if (visible) {
                        capas[nombre].addTo(map);
                    } else {
                        map.removeLayer(capas[nombre]);
                    }
                }
            }
            
            /* BLOQUE MODIFICADO PARA USAR DATOS DIRECTAMENTE DE CADA EFECTOR Y SUMAR INFO DE LA ZONA */

            function mostrarTodosEfectores() {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a.');
                    return;
                }
                if (capaEfectores) {
                    map.removeLayer(capaEfectores);
                }

                // Agrupar efectores por coordenadas redondeadas
                const efectoresAgrupados = {};
                efectoresData.forEach(feature => {
                    const coords = feature.geometry?.coordinates;
                    if (!coords) return;

                    const key = `${coords[0].toFixed(6)}|${coords[1].toFixed(6)}`;
                    if (!efectoresAgrupados[key]) {
                        efectoresAgrupados[key] = [];
                    }
                    efectoresAgrupados[key].push(feature);
                });

                const featuresAgrupadas = Object.entries(efectoresAgrupados).map(([key, grupo]) => {
                    const [lng, lat] = key.split('|').map(Number);
                    return {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [lng, lat],
                        },
                        properties: {
                            grupoEfectores: grupo.map(f => f.properties)
                        }
                    };
                });

                capaEfectores = L.geoJSON(featuresAgrupadas, {
                    pointToLayer: (feature, latlng) => {
                        const props = feature.properties.grupoEfectores[0];
                        const nombre = (props.Centro || '').toLowerCase();
                        const tipo = (props.Tipo || '').toLowerCase();

                        let icono = iconoCentroSalud;
                        const nombresEspeciales = [
                            'medicina preventiva',
                            'dem',
                            'secretar√≠a de salud',
                            'secretaria de salud',
                            'adicciones',
                            'salud mental',
                            'pec',
                            'direccion de calidad alimentaria',
                            'direccion de emergencias medicas 107',
                            'direccion de epidemiologia',
                            'laboratorio farmaceutico municipal',
                            'telesalud',
                            'pec los robles',
                            'dtc villa el libertador',
                            'pec comercial',
                            'secretar√≠a de prev. y atenc. comunitaria',
                            'secretaria de prev. y atenc. comunitaria',
                            'centro comunitario maldonado'
                        ];

                        if (tipo.includes('hospital') || tipo.includes('hpa') || nombre.includes('padre la monaca')) {
                            icono = iconoHPA;
                        } else if (nombresEspeciales.some(keyword => nombre.includes(keyword))) {
                            icono = iconoEfectores;
                        }

                        return L.marker(latlng, { icon: icono });
                    },
                    onEachFeature: (feature, layer) => {
                        const efectores = feature.properties.grupoEfectores;
                        const popups = efectores.map(props => {
                            const datosCentro = {
                                nombre: props.Centro,
                                tipo: props.Tipo,
                                direccion: props.Direccion,
                                institucion: props.institucion || '',
                                poblacion: props.PoblacionTotal ?? 0,
                                mujeres: props.Mujeres ?? 0,
                                hombres: props.Varones ?? 0,
                                sin_cobertura: props.PoblacionSinCobertura ?? 0,
                                porcentaje_sin_cobertura: props.PorcentajeSinCobertura ?? 0,
                                hogares: props.Hogares ?? 0,
                                hogares_nbi: props.HogaresNBI ?? 0
                            };
                            return crearPopupCentroSalud(datosCentro);
                        });
                        layer.bindPopup(popups.join('<hr style="margin:6px 0">'));
                    }
                }).addTo(map);
            }


            function mostrarEfectoresPorZona(zonaId) {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a.');
                    return;
                }
                if (capaEfectores) {
                    map.removeLayer(capaEfectores);
                }

                const efectoresFiltrados = efectoresData.filter(e => {
                    const props = e.properties;
                    return parseInt(props.Zona) === zonaId;
                });

                // üßÆ SUMA DATOS DE LA ZONA PARA MOSTRAR EN LA TARJETA
                const zonaStats = efectoresFiltrados.reduce((acc, e) => {
                    const p = e.properties;
                    acc.poblacion += p.PoblacionTotal || 0;
                    acc.mujeres += p.Mujeres || 0;
                    acc.hombres += p.Varones || 0;
                    acc.hogares += p.Hogares || 0;
                    acc.hogares_nbi += p.HogaresNBI || 0;
                    acc.sin_cobertura += p.PoblacionSinCobertura || 0;
                    return acc;
                }, {
                    poblacion: 0,
                    mujeres: 0,
                    hombres: 0,
                    hogares: 0,
                    hogares_nbi: 0,
                    sin_cobertura: 0
                });

                document.getElementById('zona-datos').innerHTML = `
                    <div style="font-size: 28px; font-weight: bold; text-align: center; color: #005288; margin-bottom: 10px;">
                        ${zonaStats.poblacion.toLocaleString('es-AR')}
                    </div>
                    <div style="font-size: 14px; line-height: 1.5;">
                        <div><b style="color:#E5B8D9;">Mujeres:</b> ${zonaStats.mujeres.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.mujeres, zonaStats.poblacion)}%)</span></div>
                        <div><b style="color:#3C5AB7;">Varones:</b> ${zonaStats.hombres.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.hombres, zonaStats.poblacion)}%)</span></div>
                        <div><b>Hogares:</b> ${zonaStats.hogares.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.hogares, zonaStats.poblacion)}%)</span></div>
                        <div><b>Hogares NBI:</b> ${zonaStats.hogares_nbi.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.hogares_nbi, zonaStats.poblacion)}%)</span></div>
                        <div><b>Pob. Cobertura P√∫blica Excl:</b> ${zonaStats.sin_cobertura.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.sin_cobertura, zonaStats.poblacion)}%)</span></div>
                    </div>
                `;
                document.getElementById('zona-titulo').textContent = `Poblaci√≥n de Zona ${zonaId}`;
                zonaInfoPanel.style.display = 'flex';
                allZonesSummaryPanel.style.display = 'none';

                // Agrupar efectores por coordenadas
                const coordenadasUnicas = {};
                efectoresFiltrados.forEach(feature => {
                    const lat = feature.geometry.coordinates[1];
                    const lng = feature.geometry.coordinates[0];
                    const key = `${lat},${lng}`;

                    if (!coordenadasUnicas[key]) {
                        coordenadasUnicas[key] = [];
                    }
                    coordenadasUnicas[key].push(feature);
                });

                capaEfectores = L.layerGroup();

                Object.entries(coordenadasUnicas).forEach(([key, features]) => {
                    const [lat, lng] = key.split(',').map(parseFloat);
                    const props = features[0].properties;
                    const nombre = (props.Centro || '').toLowerCase();
                    const tipo = (props.Tipo || '').toLowerCase();

                    let icono = iconoCentroSalud;
                    const nombresEspeciales = [
                        'medicina preventiva',
                        'dem',
                        'secretar√≠a de salud',
                        'secretaria de salud',
                        'adicciones',
                        'salud mental',
                        'pec',
                        'direccion de calidad alimentaria',
                        'direccion de emergencias medicas 107',
                        'direccion de epidemiologia',
                        'laboratorio farmaceutico municipal',
                        'telesalud',
                        'pec los robles',
                        'dtc villa el libertador',
                        'pec comercial',
                        'secretar√≠a de prev. y atenc. comunitaria',
                        'secretaria de prev. y atenc. comunitaria',
                        'centro comunitario maldonado'
                    ];
                    if (tipo.includes('hospital') || tipo.includes('hpa') || nombre.includes('padre la monaca')) {
                        icono = iconoHPA;
                    } else if (nombresEspeciales.some(keyword => nombre.includes(keyword))) {
                        icono = iconoEfectores;
                    }

                    const popupHtml = features.map(f => {
                        const p = f.properties;
                        const datosCentro = {
                            nombre: p.Centro,
                            tipo: p.Tipo,
                            direccion: p.Direccion,
                            institucion: p.institucion || '',
                            poblacion: p.PoblacionTotal ?? 0,
                            mujeres: p.Mujeres ?? 0,
                            hombres: p.Varones ?? 0,
                            sin_cobertura: p.PoblacionSinCobertura ?? 0,
                            porcentaje_sin_cobertura: p.PorcentajeSinCobertura ?? 0,
                            hogares: p.Hogares ?? 0,
                            hogares_nbi: p.HogaresNBI ?? 0
                        };
                        return crearPopupCentroSalud(datosCentro);
                    }).join('<hr style="margin:8px 0;">');

                    const marker = L.marker([lat, lng], { icon: icono }).bindPopup(popupHtml);
                    capaEfectores.addLayer(marker);
                });

                capaEfectores.addTo(map);
            }
            let capaCalor = null;

            function mostrarMapaDeCalor(geojson) {
                // Limpiar heatmap anterior si existe
                if (capaHeatmap) {
                    map.removeLayer(capaHeatmap);
                }

                // Filtros aplicados
                const anio = document.getElementById('filtro-anio').value;
                const mes = document.getElementById('filtro-mes').value;
                const semana = document.getElementById('filtro-semana').value;   // ‚úÖ leer semana ac√°
                const diagnostico = document.getElementById('filtro-diagnostico').value;

                // Convertir a puntos de calor con filtros
                const heatmapPoints = (geojson.features || [])
                    .filter(f => f.geometry && f.geometry.coordinates)
                    .filter(f => {
                    const p = f.properties || {};
                    const y = P.year(p);
                    const m = P.month(p);
                    const w = P.week(p);
                    const d = P.diag(p);

                    const condAnio   = (!anio   || String(y) == String(anio));
                    const condMes    = (!mes    || String(m) == String(mes));
                    const condSemana = (!semana || String(w) == String(semana));  // ‚úÖ usar "semana" (no "semanaSel")
                    const condDiag   = (!diagnostico || String(d) === String(diagnostico));

                    return condAnio && condMes && condSemana && condDiag;
                    })
                    .map(f => {
                    const [lng, lat] = f.geometry.coordinates;
                    return [lat, lng, 0.5]; // intensidad fija o variable
                    });

                // Crear capa heatmap y agregar al mapa
                capaHeatmap = L.heatLayer(heatmapPoints, {
                    radius: 10,
                    blur: 15,
                    maxZoom: 17,
                    gradient: {
                        0.1: '#B8E986', // azul claro
                        0.3: '#B8E986', // celeste m√°s fuerte
                        0.5: '#FFFF8C', // amarillo claro
                        0.7: '#F7C27B', // naranja claro
                        1.0: '#E73235'  // rojo suave
                    }
                });

                capaHeatmap.addTo(map);
            }

            function actualizarDiagnosticos() {
                const anio    = document.getElementById('filtro-anio').value;
                const mes     = document.getElementById('filtro-mes').value;
                const semana  = document.getElementById('filtro-semana').value;

                const set = new Set();

                (atencionesData?.features || []).forEach(f => {
                    const p = f.properties || {};
                    const y = P.year(p);
                    const m = P.month(p);
                    const w = P.week(p);
                    const d = P.diag(p);

                    const okAnio   = (!anio   || String(y) == String(anio));
                    const okMes    = (!mes    || String(m) == String(mes));
                    const okSemana = (!semana || String(w) == String(semana));

                    if (okAnio && okMes && okSemana && d) {
                        set.add(String(d).trim());
                    }
                });

                const sel = document.getElementById('filtro-diagnostico');
                sel.innerHTML = '<option value="">-- Diagn√≥stico --</option>';
                if (diagChoices) {
                    diagChoices.clearStore();
                }

                const opciones = [...set].sort().map(v => ({ value: v, label: v }));
                if (diagChoices) {
                    diagChoices.setChoices(opciones, 'value', 'label', true);
                } else {
                    opciones.forEach(o => {
                        const opt = document.createElement('option');
                        opt.value = o.value; 
                        opt.textContent = o.label;
                        sel.appendChild(opt);
                    });
                }
}

            function crearPopupCentroSalud(datos) {
                const tipo = (datos.tipo || '').toLowerCase();
                const nombre = (datos.nombre || '').toLowerCase();

                const nombresEspeciales = [
                    'medicina preventiva',
                    'dem',
                    'secretar√≠a de salud',
                    'secretaria de salud',
                    'adicciones',
                    'salud mental',
                    'pec',
                    'direccion de calidad alimentaria',
                    'direccion de emergencias medicas 107',
                    'direccion de epidemiologia',
                    'laboratorio farmaceutico municipal',
                    'telesalud',
                    'pec los robles',
                    'dtc villa el libertador',
                    'pec comercial',
                    'secretar√≠a de prev. y atenc. comunitaria',
                    'secretaria de prev. y atenc. comunitaria',
                    'centro comunitario maldonado'
                ];

                const isHospital = tipo.includes('hospital');
                const isHPA = tipo.includes('hpa');
                const isEfectorEspecialA = nombre.includes('padre la monaca');
                const isEfectorEspecialB = nombresEspeciales.some(keyword => nombre.includes(keyword));

                const nombreLimpio = (datos.nombre || 'Centro de Salud').split('#')[0].trim();

                if (isHospital || isHPA || isEfectorEspecialA || isEfectorEspecialB) {
                    return `
                        <div style="font-family: sans-serif; min-width: 240px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                ${nombreLimpio}
                            </div>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div><b>Instituci√≥n:</b> ${nombreLimpio}</div>
                                <div><b>Tipo:</b> ${datos.tipo || 'S/D'}</div>
                                <div><b>Direcci√≥n:</b> ${datos.direccion || 'S/D'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    const poblacionFormatted = datos.poblacion?.toLocaleString('es-AR') || '0';
                    const sinCoberturaFormatted = datos.sin_cobertura?.toLocaleString('es-AR') || '0';
                    const mujeresFormatted = datos.mujeres?.toLocaleString('es-AR') || '0';
                    const hombresFormatted = datos.hombres?.toLocaleString('es-AR') || '0';
                    const hogaresFormatted = datos.hogares?.toLocaleString('es-AR') || '0';
                    const hogaresNBIFormatted = datos.hogares_nbi?.toLocaleString('es-AR') || '0';
                    const porcentajeSinCoberturaFormatted = 
                        datos.porcentaje_sin_cobertura !== undefined && datos.porcentaje_sin_cobertura !== null
                            ? datos.porcentaje_sin_cobertura 
                            : '0%';

                    return `
                        <div style="font-family: sans-serif; min-width: 240px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                ${nombreLimpio}
                            </div>
                            <div style="font-size: 24px; font-weight: 600; text-align: center; color: #005288; margin-bottom: 8px;">
                                ${poblacionFormatted}
                            </div>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div><b>Instituci√≥n:</b> ${nombreLimpio}</div>
                                <div><b>Tipo:</b> ${datos.tipo || 'S/D'}</div>
                                <div><b>Direcci√≥n:</b> ${datos.direccion || 'S/D'}</div>
                                <div><b>Pob. Cobertura P√∫blica Excl:</b> ${sinCoberturaFormatted}
                                    <span style="color:gray">(${porcentajeSinCoberturaFormatted})</span>
                                </div>
                                <div><b style="color:#E5B8D9;">Mujeres:</b> ${mujeresFormatted} <span style="color:gray">(${porcentaje(datos.mujeres, datos.poblacion)}%)</span></div>
                                <div><b style="color:#3C5AB7;">Varones:</b> ${hombresFormatted} <span style="color:gray">(${porcentaje(datos.hombres, datos.poblacion)}%)</span></div>
                                <div><b>Hogares:</b> ${hogaresFormatted} <span style="color:gray">(${porcentaje(datos.hogares, datos.poblacion)}%)</span></div>
                                <div><b>Hogares NBI:</b> ${hogaresNBIFormatted} <span style="color:gray">(${porcentaje(datos.hogares_nbi, datos.poblacion)}%)</span></div>
                            </div>
                        </div>
                    `;
                }
            }



            function porcentaje(parte, total) {
                if (isNaN(parte) || isNaN(total) || total === 0 || parte === null || total === null) return '0';
                return ((parte / total) * 100).toFixed(2);
            }

            function mostrarResumenTodasZonas() {            
                if (!Array.isArray(datosZonasPoblacion) || datosZonasPoblacion.length === 0) {
                    console.warn('‚ùå datosZonasPoblacion no cargado o vac√≠o, no se puede mostrar el resumen.');
                    return;
                }

                allZonesList.innerHTML = '';
                const panelHeader = allZonesSummaryPanel.querySelector('h3');
                panelHeader.innerHTML = `
                    Poblaci√≥n por Zona<br>
                    <span style="font-size: 13px; font-weight: normal; color: #444;">
                        Poblaci√≥n Total de Capital: 1.505.099
                    </span>
                `;

                totalCapitalPopulationDiv.style.display = 'none';

                const zonasOrdenadas = [...datosZonasPoblacion].sort((a, b) => parseInt(a.Zona) - parseInt(b.Zona));

                zonasOrdenadas.forEach(z => {
                    const id = z.Zona;
                    const poblacion = z.PoblacionTotal || 0;
                    const poblacionFormatted = poblacion.toLocaleString('es-AR');

                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span class="zone-name">ZONA ${id}:</span>
                        <span class="zone-population">${poblacionFormatted}</span>
                    `;
                    allZonesList.appendChild(listItem);
                });

                zonaInfoPanel.style.display = 'none';
                allZonesSummaryPanel.style.display = 'flex';
            }
    
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</body>
</html>