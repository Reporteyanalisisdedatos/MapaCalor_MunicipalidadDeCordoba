<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Mapa Sanitario - Provincia de C√≥rdoba</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #leyenda-iconos {
            background: white;
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-family: sans-serif;
            font-size: 12px;
            line-height: 1.6;
        }


        body {
            margin: 0;
            padding: 0;
            
        }

        #page-header {
            width: 100%;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 1001;
            background-color: #005288; /* ‚¨ÖÔ∏è Asegura visibilidad en sticky */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #header-blue {
        background-color: #005288;
        color: white;
        padding: 20px 20px;
        min-height: 50px;
        font-family: sans-serif;
        position: relative;  /* Necesario para centrar el t√≠tulo */
        }

        #header-title {
        font-size: 24px;
        font-weight: bold;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 50%;
        transform: translate(-50%, -50%);
        white-space: nowrap;
        }

        #header-logos {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
        }

        .logo-container {
            margin-left: 20px;
            display: flex;
            align-items: center;
        }

        .logo-container img {
            height: 50px; /* Ajustado el tama√±o de los logos */
            max-width: none;
        }

        #header-bars {
            display: flex;
            height: 5px;
            width: 100%;
        }

        .bar {
            flex-grow: 1;
            height: 100%;
        }

        #filters-container {
            width: 100%;
            position: fixed;
            top: 95px;
            left: 0;
            background-color: #f8f8f8;
            padding: 15px 20px;
            box-sizing: border-box;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            align-items: stretch; /* Asegura que los grupos de filtros est√©n a la misma altura */
        }

        .filter-group {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            font-family: sans-serif;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            align-items: stretch; /* üëà esto alinea todo al ancho completo */
            min-width: 180px;
            gap: 10px;
        }



        .filter-group-title {
            font-weight: bold;
            color: #005288;
            margin-bottom: 10px;
            text-align: center;
            font-size: 16px;
        }

        .filter-group-content {
            display: flex;
            flex-direction: column;  /* üëà uno debajo del otro */
            align-items: flex-start; /* üëà alinear a la izquierda */
            gap: 10px; 
        }

        #filters-container label {
            font-size: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            white-space: nowrap;
        }

        #filters-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 10px;
        }


        #filters-container input[type="checkbox"],
        #filters-container select {
            margin-right: 8px;
            transform: scale(1.1);
        }

        #filters-container select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #map {
            position: absolute;
            top: 210px; /* altura total del header + filtros */
            bottom: 0;
            left: 360;
            right: 0;
            z-index: 1; /* para que no quede tapado por los filtros */
        }

        /* Panel de info de ZONA individual */
        #zona-info {
            display: none;
            position: absolute;
            top: 250px;
            right: 20px;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.3);
            font-family: sans-serif;
            z-index: 1100;
            width: 340px;
            flex-direction: column;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        #zona-titulo {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #005288;
            text-align: center;
        }

        /* Panel de resumen de TODAS las ZONAS */
        #all-zones-summary-panel {
            display: none;
            position: absolute;
            top: 250px;
            right: 20px;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.3);
            font-family: sans-serif;
            z-index: 1100;
            width: 280px;
            flex-direction: column;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }
        #all-zones-summary-panel h3 {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #005288;
            text-align: center;
        }
        #all-zones-summary-panel ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }
        #all-zones-summary-panel li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        #all-zones-summary-panel li:last-child {
            border-bottom: none;
        }
        #all-zones-summary-panel li .zone-name {
            font-weight: bold;
            color: #333;
        }
        #all-zones-summary-panel li .zone-population {
            color: #005288;
            font-weight: bold;
        }
        
        /* Estilos para el bot√≥n de retorno - AJUSTADOS */
        #return-button {
        width: 30px;
        height: 27px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        margin: 0;
        margin-top: 5px; /* üîß Ajuste fino para alinear con el select */
        }

        #return-button:hover {
        background-color: #f0f0f0;
        }

        #return-button img {
        width: 50px;
        height: 50px;
        display: block;
        margin: 0;
        padding: 0;
        mix-blend-mode: multiply;
        }

        /* Estilos para las etiquetas de nombre sobre las capas */
        .layer-label {
            position: absolute;
            background-color: transparent;
            color: #005288;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            pointer-events: none;
            transform: translate(-50%, -50%);
            text-shadow: 
                -1px -1px 3px rgba(255, 255, 255, 0.9), 
                1px -1px 3px rgba(255, 255, 255, 0.9), 
                -1px 1px 3px rgba(255, 255, 255, 0.9), 
                1px 1px 3px rgba(255, 255, 255, 0.9),
                0px 0px 5px rgba(255, 255, 255, 0.7);  
        }
        #left-panel {
            position: fixed;
            top: 95px;
            left: 0;
            bottom: 0;
            width: 360px;
            background-color: #f8f8f8;
            padding: 10px 15px;
            box-shadow: 2px 0 6px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #filters-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #map {
            position: absolute;
            top: 95px;
            bottom: 0;
            left: 330px; /* se corre para dejar lugar al panel */
            right: 0;
            z-index: 1;
        }

        #search-container {
            margin-bottom: 15px;
        }

        #search-efector {
            width: 100%;           /* ‚¨ÖÔ∏è Reduc√≠ el ancho */
            margin: 0 auto;       /* ‚¨ÖÔ∏è Centra dentro del contenedor */
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
        }

        #leyenda-iconos img {
            height: 20px;
            width: auto;
            vertical-align: middle;
            margin-right: 8px;
        }

    </style>
</head>
<body>
    <div id="header-blue">
            <div id="header-title">Mapa Sanitario - Municipalidad de C√≥rdoba</div>
            <div id="header-logos">
                <div class="logo-container">
                    <img src="https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/SecreB.png" alt="Secretar√≠a de Salud" />
                </div>
                <div class="logo-container">
                    <img src="https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/HorizontalCTWhite.png" alt="Coordinaci√≥n Tecnol√≥gica" />
                </div>
            </div>
        </div>

    
        <div id="header-bars">
            <div class="bar" style="background-color: #FFDA63;"></div>
            <div class="bar" style="background-color: #DC3545;"></div>
            <div class="bar" style="background-color: #007BFF;"></div>
        </div>
    </div>

    <div id="left-panel">
        <!-- 2. BUSCADOR -->
        <div id="search-container">
            <input type="text" id="search-efector" placeholder="Buscar Efector..." />
        </div>

        <!-- 1. LEYENDA -->
        <div id="leyenda-iconos">
            <div><img src="CS.png"> Centros de Salud</div>
            <div><img src="HOSP-HPA-PLM.png"> Hospitales Municipales, HPA, Padre La Monaca</div>
            <div><img src="EFECTORES.png"> Efectores Municipales</div>
        </div>

        <!-- 3. FILTROS PROVINCIA -->
        <div class="filter-group">
            <div class="filter-group-title">Filtros a Nivel Provincia</div>
            <div class="filter-group-content">
            <label><input type="checkbox" id="chkDEPARTAMENTOS" /> DEPARTAMENTOS</label>
            <label><input type="checkbox" id="chkLOCALIDADES" /> LOCALIDADES</label>
            </div>
        </div>

        <!-- 4. FILTROS CAPITAL -->
        <div class="filter-group">
            <div class="filter-group-title">Filtros a Nivel Capital</div>
            <div class="filter-group-content">
            <label for="selZONA">
                <div style="display: flex; align-items: center; gap: 6px;">
                <div id="return-button" style="display: none; cursor: pointer;">
                    <img src="atras.png" alt="Volver" style="width: 22px; height: 22px;" />
                </div>
                <select id="selZONA">
                    <option value="">-- Seleccionar Zona --</option>
                    <option value="all">Todas las Zonas</option>
                </select>
                </div>
            </label>
            <label><input type="checkbox" id="chkCIRCUITO" /> CIRCUITOS</label>
            <label><input type="checkbox" id="chkSECCIONALES" /> SECCIONALES</label>
            <label><input type="checkbox" id="chkENTEMETROPOLITANO" /> ENTE METROPOLITANO</label>
            </div>
        </div>

        </div>

    <div id="map"></div>

    <div id="zona-info">
        <div
            id="zona-titulo"
            style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #005288;"
        >
            Poblaci√≥n de Zona
        </div>
        <div id="zona-datos"></div>
    </div>

    <div id="all-zones-summary-panel">
        <h3>Poblaci√≥n por Zona</h3>
        <div id="total-capital-population" class="total-population" style="display: none;"></div>
        <ul id="all-zones-list"></ul>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let efectoresData = null;
        let capaEfectores = null;
        const capas = {}; // Objeto para almacenar las capas de GeoJSON (la geometr√≠a)
        const capasLabels = {}; // Objeto para almacenar las capas de etiquetas (los nombres)
        let allZonasFeatures = []; // Para guardar todas las features de zonas
        let allZonasDataLoaded = false; // Flag para saber si los datos de zonas est√°n cargados

        // Referencias a los elementos del DOM
        const selZONA = document.getElementById('selZONA');
        const returnButton = document.getElementById('return-button');
        const zonaInfoPanel = document.getElementById('zona-info');
        const allZonesSummaryPanel = document.getElementById('all-zones-summary-panel');
        const allZonesList = document.getElementById('all-zones-list');
        const totalCapitalPopulationDiv = document.getElementById('total-capital-population');
        
        let datosZonasPoblacion = [];

        document.addEventListener("DOMContentLoaded", () => {
                      
            const map = L.map('map').setView([-31.42, -64.18], 11);

            const iconoEfectores = L.icon({
                iconUrl:'https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/EFECTORES.png',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36],
            });

            

            const iconoHPA = L.icon({
                iconUrl: 'https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/HOSP-HPA-PLM.png',
                iconSize: [38, 38],
                iconAnchor: [19, 38],
                popupAnchor: [0, -38],
            });

            const iconoCentroSalud = L.icon({
                iconUrl: 'https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/CS.png', // Aseg√∫rate de tener esta imagen en la misma carpeta
                iconSize: [28, 28],
                iconAnchor: [14, 28],
                popupAnchor: [0, -28],
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(map);

            const estilos = (feature) => ({
                color: feature.properties.stroke || '#3388ff',
                weight: feature.properties['stroke-width'] || 2,
                opacity: feature.properties['stroke-opacity'] || 1,
                fillColor: feature.properties.fill || '#3388ff',
                fillOpacity: feature.properties['fill-opacity'] || 0.3,
            });

            // Funci√≥n para obtener el nombre de la feature (para etiquetas y popups)
            function getFeatureName(props, layerName) {
                // *** POR FAVOR, REEMPLAZA 'nombre_propiedad_real' CON EL NOMBRE DE LA PROPIEDAD EN TUS JSONS ***
                // EJEMPLO: if (layerName === 'BARRIOS' && props.hasOwnProperty('NOMBRE_DEL_BARRIO')) { return props.NOMBRE_DEL_BARRIO; }
                if (layerName === 'BARRIOS' && props.hasOwnProperty('nombre_propiedad_real_barrio')) { 
                    return props.nombre_propiedad_real_barrio;
                }
                if (layerName === 'CIRCUITO' && props.hasOwnProperty('circuito')) { 
                    return props.circuito;
                }
                if (layerName === 'LOCALIDADES' && props.hasOwnProperty('nombre_propiedad_real_localidad')) { 
                    return props.nombre_propiedad_real_localidad;
                }
                if (layerName === 'SECCIONALES' && props.hasOwnProperty('nombre_seccional')) { // Ejemplo, si seccionales tiene una propiedad diferente
                    return props.nombre_seccional;
                }
                if (layerName === 'ENTEMETROPOLITANO' && props.hasOwnProperty('localidad')) {
                    return props.localidad;
                }
                if (layerName === 'DEPARTAMENTOS' && props.hasOwnProperty('nombre_departamento')) { // Ejemplo
                    return props.nombre_departamento;
                }


                // Prioridad gen√©rica (si no se especifica una propiedad para la capa)
                if (props.name) return props.name;
                if (props.NOM_ZONA) return props.NOM_ZONA;
                if (props.CODIGO) return props.CODIGO;

                // Si no se encuentran las anteriores, busca la primera propiedad que parezca un nombre
                for (const key in props) {
                    if (typeof props[key] === 'string' && props[key].length > 1 && !/^\d+$/.test(props[key])) {
                        return props[key];
                    }
                }
                console.warn(`No se encontr√≥ una propiedad de nombre clara para la capa ${layerName}. Propiedades:`, props);
                return 'Sin nombre';
            }

            // Funci√≥n para calcular el centroide del bounding box de un pol√≠gono/multipol√≠gono (m√°s simple)
            function getCentroid(feature) {
                if (feature.geometry && feature.geometry.coordinates) {
                    try {
                        const geoJsonLayer = L.geoJSON(feature);
                        if (geoJsonLayer.getBounds().isValid()) {
                            return geoJsonLayer.getBounds().getCenter();
                        } else {
                            console.warn("Bounds inv√°lidos para la feature, no se pudo calcular el centroide:", feature);
                            return null;
                        }
                    } catch (e) {
                        console.error("Error al calcular el centroide para la feature:", feature, e);
                        return null;
                    }
                }
                return null;
            }

            // Cargar efectores y zonas
           const fetchEfectores = fetch("https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/efectores.geojson")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar efectores.json: ${res.status}`);
                    return res.json();
                });

            const fetchZonasGeo = fetch("https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/zonas.geojson")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar zonas.geojson: ${res.status}`);
                    return res.json();
                });

            const fetchZonasValores = fetch("https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/zonas_valores.json")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar zonas_valores.json: ${res.status}`);
                    return res.json();
                });


            Promise.all([fetchEfectores, fetchZonasGeo, fetchZonasValores])
                .then(([efectores, zonasGeo, zonasValores]) => {
                    if (!efectores || !efectores.features) {
                        throw new Error("efectores.json no tiene la estructura esperada.");
                    }
                    if (!zonasGeo || !zonasGeo.features) {
                        throw new Error("zonas.geojson no tiene la estructura esperada.");
                    }
                    if (!Array.isArray(zonasValores)) {
                        throw new Error("zonas_valores.json no es un array.");
                    }

                    efectoresData = efectores.features;
                    allZonasFeatures = zonasGeo.features;
                    datosZonasPoblacion = zonasValores;
                    allZonasDataLoaded = true;

                    console.log("‚úÖ efectores cargados:", efectoresData.length);
                    poblarSelectorZonas(allZonasFeatures);
                    mostrarTodosEfectores();
                    selZONA.value = "";
                    zonaInfoPanel.style.display = 'none';
                    allZonesSummaryPanel.style.display = 'none';
                    returnButton.style.display = 'none';
                
                     // üëá PEG√Å ESTO ADENTRO DEL THEN
                    document.getElementById('search-efector').addEventListener('input', (e) => {
                        let texto = e.target.value.trim().toLowerCase()
                            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // saca acentos
                            .replace(/\bcs\b/g, 'cs') // reemplaza "cs" por "centro de salud";
                            .replace(/\bcs[\s#¬∞¬∫\-]*/g, 'centro de salud ')
                            .replace(/n[¬∞¬∫]?\s*/g, '') // reemplaza "n¬∞", "n¬∫", "n " por vac√≠o
                            .replace(/\s+/g, ' ');     // normaliza espacios dobles


                        if (!texto) {
                            mostrarTodosEfectores();
                            return;
                        }

                        const filtrados = efectoresData.filter(feature => {
                            const nombre = feature.properties?.Centro?.toLowerCase() || '';
                            const nombreNormalizado = nombre
                                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                                .replace(/\bcs\b/g, 'centro de salud')
                                .replace(/\bcs\b/g, 'cs') // reemplaza "cs" por "centro de salud";
                                .replace(/\bcs[\s#¬∞¬∫\-]*/g, 'centro de salud ')
                                .replace(/n[¬∞¬∫]?\s*/g, '') // reemplaza "n¬∞", "n¬∫", "n " por vac√≠o
                                .replace(/\s+/g, ' ');     // normaliza espacios dobles

                            return nombreNormalizado.includes(texto);
                        });

                        if (capaEfectores) {
                            map.removeLayer(capaEfectores);
                        }

                        capaEfectores = L.geoJSON(filtrados, {
                            pointToLayer: (feature, latlng) => {
                            const props = feature.properties;
                            const nombre = (props.Centro || '').toLowerCase();
                            const tipo = (props.Tipo || '').toLowerCase();

                            let icono = iconoCentroSalud;

                            const nombresEspeciales = [
                                'medicina preventiva',
                                'dem',
                                'secretar√≠a de salud',
                                'secretaria de salud',
                                'adicciones',
                                'salud mental',
                                'pec',
                                'direccion de calidad alimentaria',
                                'direccion de emergencias medicas 107',
                                'direccion de epidemiologia',
                                'laboratorio farmaceutico municipal',
                                'telesalud',
                                'pec los robles',
                                'dtc villa el libertador',
                                'pec comercial',
                                'secretar√≠a de prev. y atenc. comunitaria',
                                'secretaria de prev. y atenc. comunitaria',
                                'centro comunitario maldonado'
                            ];

                            if (tipo.includes('hospital') || tipo.includes('hpa') || nombre.includes('padre la monaca')) {
                                icono = iconoHPA;
                            } else if (nombresEspeciales.some(keyword => nombre.includes(keyword))) {
                                icono = iconoEfectores;
                            }

                            return L.marker(latlng, { icon: icono });
                        },
                            onEachFeature: (feature, layer) => {
                                const props = feature.properties;
                                const datosCentro = {
                                    nombre: props.Centro,
                                    tipo: props.Tipo,
                                    direccion: props.Direccion,
                                    institucion: props.institucion || '',
                                    poblacion: props.PoblacionTotal ?? 0,
                                    mujeres: props.Mujeres ?? 0,
                                    hombres: props.Varones ?? 0,
                                    sin_cobertura: props.PoblacionSinCobertura ?? 0,
                                    porcentaje_sin_cobertura: props.PorcentajeSinCobertura ?? 0,
                                    hogares: props.Hogares ?? 0,
                                    hogares_nbi: props.HogaresNBI ?? 0
                                };
                                layer.bindPopup(crearPopupCentroSalud(datosCentro));
                            }
                        }).addTo(map);
                    });

                })
                
                .catch(error => {
                    console.error("Error cargando datos iniciales:", error);
                    if (error.message.includes("Failed to fetch")) {
                        alert("No se pudo conectar al servidor. Verific√° tu conexi√≥n a internet.");
                    } else {
                        alert(`Error al cargar datos: ${error.message}`);
                    }
                });

            const archivosCapas = [
                'CIRCUITO',
                'SECCIONALES',
                'DEPARTAMENTOS',
                'LOCALIDADES',
                'ENTEMETROPOLITANO'
            ];
            const urlBase ="https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Municipalidad-de-Cordoba/";

            archivosCapas.forEach((nombre) => {
                fetch(`${urlBase}${nombre}.json`)
                    .then((res) => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status} for ${nombre}.json`);
                        }
                        return res.json();
                    })
                    .then((geojson) => {
                        capas[nombre] = L.geoJSON(geojson, {
                            style: estilos,
                            onEachFeature: (feature, layer) => {
                                // Usar getFeatureName con el nombre de la capa
                                const nom = getFeatureName(feature.properties, nombre);
                                layer.bindPopup(`<strong>${nom}</strong>`);
                            },
                        });

                        // Crear y almacenar los marcadores de etiqueta para esta capa
                        const labelsGroup = L.layerGroup();
                        geojson.features.forEach(feature => {
                            const centroid = getCentroid(feature);
                            if (centroid) {
                                // Usar getFeatureName con el nombre de la capa
                                const name = getFeatureName(feature.properties, nombre);
                                if (name && name !== 'Sin nombre') { 
                                    const labelHtml = `<div class="layer-label">${name}</div>`;
                                    const customIcon = L.divIcon({
                                        className: 'custom-div-icon',
                                        html: labelHtml,
                                        iconSize: [0, 0], 
                                        iconAnchor: [0, 0]
                                    });
                                    const labelMarker = L.marker(centroid, { icon: customIcon });
                                    labelsGroup.addLayer(labelMarker);
                                }
                            }
                        });
                        capasLabels[nombre] = labelsGroup;

                    })
                    .catch((error) => {
                        console.error(`Error cargando ${nombre}.json:`, error);
                        console.log(`Aseg√∫rate de que ${nombre}.json exista, sea un GeoJSON v√°lido y tenga una propiedad de nombre legible.`);
                    });
            });

            function poblarSelectorZonas(zonasFeatures) {
                // Ordenar las zonas num√©ricamente
                zonasFeatures.sort((a, b) => {
                    const idA = parseInt((a.properties.name || '').replace('ZONA ', '').trim());
                    const idB = parseInt((b.properties.name || '').replace('ZONA ', '').trim());
                    return idA - idB;
                });

                zonasFeatures.forEach((feature) => {
                    const zona_id_str = (feature.properties.name || '').replace('ZONA ', '').trim();
                    if (zona_id_str) {
                        const option = document.createElement('option');
                        option.value = zona_id_str;
                        option.textContent = `ZONA ${zona_id_str}`;
                        selZONA.appendChild(option);
                    }
                });

                selZONA.onchange = (e) => {
                    const selectedValue = e.target.value;
                    if (capas.ZONA && map.hasLayer(capas.ZONA)) {
                        map.removeLayer(capas.ZONA);
                    }

                    zonaInfoPanel.style.display = 'none';
                    allZonesSummaryPanel.style.display = 'none';

                    if (selectedValue === 'all') {
                        capas.ZONA = L.geoJSON(
                            {
                                type: 'FeatureCollection',
                                features: allZonasFeatures
                            },
                            {
                                style: estilos,
                                onEachFeature: (feature, layer) => {
                                    const zona_id_str = (feature.properties.name || '').replace('ZONA ', '').trim();
                                    const zona_id = parseInt(zona_id_str) || 0;

                                    layer.on('click', () => {
                                        selZONA.value = zona_id_str;
                                        mostrarEfectoresPorZona(zona_id);
                                        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                                        returnButton.style.display = 'block';
                                        zonaInfoPanel.style.display = 'flex';
                                        allZonesSummaryPanel.style.display = 'none';
                                    });
                                }
                            }
                        ).addTo(map);

                        mostrarTodosEfectores();
                        mostrarResumenTodasZonas();
                        map.setView([-31.42, -64.18], 11);
                        returnButton.style.display = 'block';

                    } else if (selectedValue) {
                        const selectedFeature = allZonasFeatures.find(f =>
                            (f.properties.name || '').replace('ZONA ', '').trim() === selectedValue
                        );

                        if (selectedFeature) {
                            const zona_id = parseInt(selectedValue);
                            capas.ZONA = L.geoJSON(selectedFeature, {
                                style: estilos,
                                onEachFeature: (feature, layer) => {
                                    layer.on('click', () => {
                                        mostrarEfectoresPorZona(zona_id);
                                        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                                        zonaInfoPanel.style.display = 'flex';
                                        allZonesSummaryPanel.style.display = 'none';
                                    });
                                }
                            }).addTo(map);

                            map.fitBounds(L.geoJSON(selectedFeature).getBounds(), { padding: [20, 20] });
                            mostrarEfectoresPorZona(zona_id);
                            returnButton.style.display = 'block';
                        }

                    } else {
                        mostrarTodosEfectores();
                        zonaInfoPanel.style.display = 'none';
                        returnButton.style.display = 'none';
                        allZonesSummaryPanel.style.display = 'none';
                        map.setView([-31.42, -64.18], 11);
                    }
                };
            }

            // Manejador del bot√≥n de retorno
            returnButton.onclick = () => {
                if (selZONA.value === "all") { // Si estamos en "Todas las Zonas", ir a "-- Seleccionar Zona --"
                    selZONA.value = "";
                } else { // Si estamos en una zona espec√≠fica, ir a "Todas las Zonas"
                    selZONA.value = "all";
                }
                const event = new Event('change');
                selZONA.dispatchEvent(event); // Dispara el evento 'change'
            };


            document.getElementById('chkCIRCUITO').onchange = (e) =>
                toggleLayer('CIRCUITO', e.target.checked);
            document.getElementById('chkSECCIONALES').onchange = (e) =>
                toggleLayer('SECCIONALES', e.target.checked);
            document.getElementById('chkENTEMETROPOLITANO').onchange = (e) =>
                toggleLayer('ENTEMETROPOLITANO', e.target.checked);    
            document.getElementById('chkDEPARTAMENTOS').onchange = (e) =>
                toggleLayer('DEPARTAMENTOS', e.target.checked);
            document.getElementById('chkLOCALIDADES').onchange = (e) =>
                toggleLayer('LOCALIDADES', e.target.checked);

            function toggleLayer(nombre, visible) {
                if (!capas[nombre]) {
                    console.warn(`Capa de geometr√≠a '${nombre}' no cargada. Revisa el archivo JSON.`);
                    return;
                }
                // Las etiquetas son opcionales, pero si existen, se manejan
                if (capasLabels[nombre]) {
                    if (visible) {
                        capas[nombre].addTo(map);
                        capasLabels[nombre].addTo(map); 
                    } else {
                        map.removeLayer(capas[nombre]);
                        map.removeLayer(capasLabels[nombre]); 
                    }
                } else {
                    // Si no hay etiquetas, solo maneja la capa de geometr√≠a
                    if (visible) {
                        capas[nombre].addTo(map);
                    } else {
                        map.removeLayer(capas[nombre]);
                    }
                }
            }
            
            /* BLOQUE MODIFICADO PARA USAR DATOS DIRECTAMENTE DE CADA EFECTOR Y SUMAR INFO DE LA ZONA */

            function mostrarTodosEfectores() {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a.');
                    return;
                }
                if (capaEfectores) {
                    map.removeLayer(capaEfectores);
                }

                // Agrupar efectores por coordenadas redondeadas
                const efectoresAgrupados = {};
                efectoresData.forEach(feature => {
                    const coords = feature.geometry?.coordinates;
                    if (!coords) return;

                    const key = `${coords[0].toFixed(6)}|${coords[1].toFixed(6)}`;
                    if (!efectoresAgrupados[key]) {
                        efectoresAgrupados[key] = [];
                    }
                    efectoresAgrupados[key].push(feature);
                });

                const featuresAgrupadas = Object.entries(efectoresAgrupados).map(([key, grupo]) => {
                    const [lng, lat] = key.split('|').map(Number);
                    return {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [lng, lat],
                        },
                        properties: {
                            grupoEfectores: grupo.map(f => f.properties)
                        }
                    };
                });

                capaEfectores = L.geoJSON(featuresAgrupadas, {
                    pointToLayer: (feature, latlng) => {
                        const props = feature.properties.grupoEfectores[0];
                        const nombre = (props.Centro || '').toLowerCase();
                        const tipo = (props.Tipo || '').toLowerCase();

                        let icono = iconoCentroSalud;
                        const nombresEspeciales = [
                            'medicina preventiva',
                            'dem',
                            'secretar√≠a de salud',
                            'secretaria de salud',
                            'adicciones',
                            'salud mental',
                            'pec',
                            'direccion de calidad alimentaria',
                            'direccion de emergencias medicas 107',
                            'direccion de epidemiologia',
                            'laboratorio farmaceutico municipal',
                            'telesalud',
                            'pec los robles',
                            'dtc villa el libertador',
                            'pec comercial',
                            'secretar√≠a de prev. y atenc. comunitaria',
                            'secretaria de prev. y atenc. comunitaria',
                            'centro comunitario maldonado'
                        ];

                        if (tipo.includes('hospital') || tipo.includes('hpa') || nombre.includes('padre la monaca')) {
                            icono = iconoHPA;
                        } else if (nombresEspeciales.some(keyword => nombre.includes(keyword))) {
                            icono = iconoEfectores;
                        }

                        return L.marker(latlng, { icon: icono });
                    },
                    onEachFeature: (feature, layer) => {
                        const efectores = feature.properties.grupoEfectores;
                        const popups = efectores.map(props => {
                            const datosCentro = {
                                nombre: props.Centro,
                                tipo: props.Tipo,
                                direccion: props.Direccion,
                                institucion: props.institucion || '',
                                poblacion: props.PoblacionTotal ?? 0,
                                mujeres: props.Mujeres ?? 0,
                                hombres: props.Varones ?? 0,
                                sin_cobertura: props.PoblacionSinCobertura ?? 0,
                                porcentaje_sin_cobertura: props.PorcentajeSinCobertura ?? 0,
                                hogares: props.Hogares ?? 0,
                                hogares_nbi: props.HogaresNBI ?? 0
                            };
                            return crearPopupCentroSalud(datosCentro);
                        });
                        layer.bindPopup(popups.join('<hr style="margin:6px 0">'));
                    }
                }).addTo(map);
            }


            function mostrarEfectoresPorZona(zonaId) {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a.');
                    return;
                }
                if (capaEfectores) {
                    map.removeLayer(capaEfectores);
                }

                const efectoresFiltrados = efectoresData.filter(e => {
                    const props = e.properties;
                    return parseInt(props.Zona) === zonaId;
                });

                // üßÆ SUMA DATOS DE LA ZONA PARA MOSTRAR EN LA TARJETA
                const zonaStats = efectoresFiltrados.reduce((acc, e) => {
                    const p = e.properties;
                    acc.poblacion += p.PoblacionTotal || 0;
                    acc.mujeres += p.Mujeres || 0;
                    acc.hombres += p.Varones || 0;
                    acc.hogares += p.Hogares || 0;
                    acc.hogares_nbi += p.HogaresNBI || 0;
                    acc.sin_cobertura += p.PoblacionSinCobertura || 0;
                    return acc;
                }, {
                    poblacion: 0,
                    mujeres: 0,
                    hombres: 0,
                    hogares: 0,
                    hogares_nbi: 0,
                    sin_cobertura: 0
                });

                document.getElementById('zona-datos').innerHTML = `
                    <div style="font-size: 28px; font-weight: bold; text-align: center; color: #005288; margin-bottom: 10px;">
                        ${zonaStats.poblacion.toLocaleString('es-AR')}
                    </div>
                    <div style="font-size: 14px; line-height: 1.5;">
                        <div><b style="color:#E5B8D9;">Mujeres:</b> ${zonaStats.mujeres.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.mujeres, zonaStats.poblacion)}%)</span></div>
                        <div><b style="color:#3C5AB7;">Varones:</b> ${zonaStats.hombres.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.hombres, zonaStats.poblacion)}%)</span></div>
                        <div><b>Hogares:</b> ${zonaStats.hogares.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.hogares, zonaStats.poblacion)}%)</span></div>
                        <div><b>Hogares NBI:</b> ${zonaStats.hogares_nbi.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.hogares_nbi, zonaStats.poblacion)}%)</span></div>
                        <div><b>Pob. Cobertura P√∫blica Excl:</b> ${zonaStats.sin_cobertura.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(zonaStats.sin_cobertura, zonaStats.poblacion)}%)</span></div>
                    </div>
                `;
                document.getElementById('zona-titulo').textContent = `Poblaci√≥n de Zona ${zonaId}`;
                zonaInfoPanel.style.display = 'flex';
                allZonesSummaryPanel.style.display = 'none';

                // Agrupar efectores por coordenadas
                const coordenadasUnicas = {};
                efectoresFiltrados.forEach(feature => {
                    const lat = feature.geometry.coordinates[1];
                    const lng = feature.geometry.coordinates[0];
                    const key = `${lat},${lng}`;

                    if (!coordenadasUnicas[key]) {
                        coordenadasUnicas[key] = [];
                    }
                    coordenadasUnicas[key].push(feature);
                });

                capaEfectores = L.layerGroup();

                Object.entries(coordenadasUnicas).forEach(([key, features]) => {
                    const [lat, lng] = key.split(',').map(parseFloat);
                    const props = features[0].properties;
                    const nombre = (props.Centro || '').toLowerCase();
                    const tipo = (props.Tipo || '').toLowerCase();

                    let icono = iconoCentroSalud;
                    const nombresEspeciales = [
                        'medicina preventiva',
                        'dem',
                        'secretar√≠a de salud',
                        'secretaria de salud',
                        'adicciones',
                        'salud mental',
                        'pec',
                        'direccion de calidad alimentaria',
                        'direccion de emergencias medicas 107',
                        'direccion de epidemiologia',
                        'laboratorio farmaceutico municipal',
                        'telesalud',
                        'pec los robles',
                        'dtc villa el libertador',
                        'pec comercial',
                        'secretar√≠a de prev. y atenc. comunitaria',
                        'secretaria de prev. y atenc. comunitaria',
                        'centro comunitario maldonado'
                    ];
                    if (tipo.includes('hospital') || tipo.includes('hpa') || nombre.includes('padre la monaca')) {
                        icono = iconoHPA;
                    } else if (nombresEspeciales.some(keyword => nombre.includes(keyword))) {
                        icono = iconoEfectores;
                    }

                    const popupHtml = features.map(f => {
                        const p = f.properties;
                        const datosCentro = {
                            nombre: p.Centro,
                            tipo: p.Tipo,
                            direccion: p.Direccion,
                            institucion: p.institucion || '',
                            poblacion: p.PoblacionTotal ?? 0,
                            mujeres: p.Mujeres ?? 0,
                            hombres: p.Varones ?? 0,
                            sin_cobertura: p.PoblacionSinCobertura ?? 0,
                            porcentaje_sin_cobertura: p.PorcentajeSinCobertura ?? 0,
                            hogares: p.Hogares ?? 0,
                            hogares_nbi: p.HogaresNBI ?? 0
                        };
                        return crearPopupCentroSalud(datosCentro);
                    }).join('<hr style="margin:8px 0;">');

                    const marker = L.marker([lat, lng], { icon: icono }).bindPopup(popupHtml);
                    capaEfectores.addLayer(marker);
                });

                capaEfectores.addTo(map);
            }


            function crearPopupCentroSalud(datos) {
                const tipo = (datos.tipo || '').toLowerCase();
                const nombre = (datos.nombre || '').toLowerCase();

                const nombresEspeciales = [
                    'medicina preventiva',
                    'dem',
                    'secretar√≠a de salud',
                    'secretaria de salud',
                    'adicciones',
                    'salud mental',
                    'pec',
                    'direccion de calidad alimentaria',
                    'direccion de emergencias medicas 107',
                    'direccion de epidemiologia',
                    'laboratorio farmaceutico municipal',
                    'telesalud',
                    'pec los robles',
                    'dtc villa el libertador',
                    'pec comercial',
                    'secretar√≠a de prev. y atenc. comunitaria',
                    'secretaria de prev. y atenc. comunitaria',
                    'centro comunitario maldonado'
                ];

                const isHospital = tipo.includes('hospital');
                const isHPA = tipo.includes('hpa');
                const isEfectorEspecialA = nombre.includes('padre la monaca');
                const isEfectorEspecialB = nombresEspeciales.some(keyword => nombre.includes(keyword));

                const nombreLimpio = (datos.nombre || 'Centro de Salud').split('#')[0].trim();

                if (isHospital || isHPA || isEfectorEspecialA || isEfectorEspecialB) {
                    return `
                        <div style="font-family: sans-serif; min-width: 240px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                ${nombreLimpio}
                            </div>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div><b>Instituci√≥n:</b> ${nombreLimpio}</div>
                                <div><b>Tipo:</b> ${datos.tipo || 'S/D'}</div>
                                <div><b>Direcci√≥n:</b> ${datos.direccion || 'S/D'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    const poblacionFormatted = datos.poblacion?.toLocaleString('es-AR') || '0';
                    const sinCoberturaFormatted = datos.sin_cobertura?.toLocaleString('es-AR') || '0';
                    const mujeresFormatted = datos.mujeres?.toLocaleString('es-AR') || '0';
                    const hombresFormatted = datos.hombres?.toLocaleString('es-AR') || '0';
                    const hogaresFormatted = datos.hogares?.toLocaleString('es-AR') || '0';
                    const hogaresNBIFormatted = datos.hogares_nbi?.toLocaleString('es-AR') || '0';
                    const porcentajeSinCoberturaFormatted = 
                        datos.porcentaje_sin_cobertura !== undefined && datos.porcentaje_sin_cobertura !== null
                            ? datos.porcentaje_sin_cobertura + '%'
                            : '0%';

                    return `
                        <div style="font-family: sans-serif; min-width: 240px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                ${nombreLimpio}
                            </div>
                            <div style="font-size: 24px; font-weight: 600; text-align: center; color: #005288; margin-bottom: 8px;">
                                ${poblacionFormatted}
                            </div>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div><b>Instituci√≥n:</b> ${nombreLimpio}</div>
                                <div><b>Tipo:</b> ${datos.tipo || 'S/D'}</div>
                                <div><b>Direcci√≥n:</b> ${datos.direccion || 'S/D'}</div>
                                <div><b>Pob. Cobertura P√∫blica Excl:</b> ${sinCoberturaFormatted}
                                    <span style="color:gray">(${porcentaje(datos.sin_cobertura, datos.poblacion)}%)</span>
                                </div>
                                <div><b style="color:#E5B8D9;">Mujeres:</b> ${mujeresFormatted} <span style="color:gray">(${porcentaje(datos.mujeres, datos.poblacion)}%)</span></div>
                                <div><b style="color:#3C5AB7;">Varones:</b> ${hombresFormatted} <span style="color:gray">(${porcentaje(datos.hombres, datos.poblacion)}%)</span></div>
                                <div><b>Hogares:</b> ${hogaresFormatted} <span style="color:gray">(${porcentaje(datos.hogares, datos.poblacion)}%)</span></div>
                                <div><b>Hogares NBI:</b> ${hogaresNBIFormatted} <span style="color:gray">(${porcentaje(datos.hogares_nbi, datos.poblacion)}%)</span></div>
                            </div>
                        </div>
                    `;
                }
            }



            function porcentaje(parte, total) {
                if (isNaN(parte) || isNaN(total) || total === 0 || parte === null || total === null) return '0';
                return ((parte / total) * 100).toFixed(2);
            }

            function mostrarResumenTodasZonas() {            
                if (!Array.isArray(datosZonasPoblacion) || datosZonasPoblacion.length === 0) {
                    console.warn('‚ùå datosZonasPoblacion no cargado o vac√≠o, no se puede mostrar el resumen.');
                    return;
                }

                allZonesList.innerHTML = '';
                const panelHeader = allZonesSummaryPanel.querySelector('h3');
                panelHeader.innerHTML = `
                    Poblaci√≥n por Zona<br>
                    <span style="font-size: 13px; font-weight: normal; color: #444;">
                        Poblaci√≥n Total de Capital: 1.505.099
                    </span>
                `;

                totalCapitalPopulationDiv.style.display = 'none';

                const zonasOrdenadas = [...datosZonasPoblacion].sort((a, b) => parseInt(a.Zona) - parseInt(b.Zona));

                zonasOrdenadas.forEach(z => {
                    const id = z.Zona;
                    const poblacion = z.PoblacionTotal || 0;
                    const poblacionFormatted = poblacion.toLocaleString('es-AR');

                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span class="zone-name">ZONA ${id}:</span>
                        <span class="zone-population">${poblacionFormatted}</span>
                    `;
                    allZonesList.appendChild(listItem);
                });

                zonaInfoPanel.style.display = 'none';
                allZonesSummaryPanel.style.display = 'flex';
            }
    
        });
    </script>

</body>
</html>
